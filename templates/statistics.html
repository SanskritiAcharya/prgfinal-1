{% extends "base.html" %}

{% block title %}Statistics - Ecotrack{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">Your Waste Statistics</h1>
    
    <div class="stats-overview">
        <div class="stat-box">
            <h3>{{ total_entries }}</h3>
            <p>Total Entries</p>
        </div>
        <div class="stat-box">
            <h3>{{ "%.2f"|format(total_weight) }} kg</h3>
            <p>Total Waste</p>
        </div>
        <div class="stat-box">
            <h3>{{ recycled_count }}</h3>
            <p>Items Recycled</p>
        </div>
        <div class="stat-box">
            <h3>{{ "%.2f"|format(recycled_weight) }} kg</h3>
            <p>Recycled Weight</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <h2>Waste by Type</h2>
            <canvas id="wasteTypeChart"></canvas>
        </div>
        
        <div class="chart-card">
            <h2>Weekly Waste Trend</h2>
            <canvas id="weeklyChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

    <div class="impact-section">
        <h2>Environmental Impact</h2>
        <div class="impact-grid">
            <div class="impact-card">
                <div class="impact-icon">üå±</div>
                <h3>{{ "%.2f"|format(co2_saved) }} kg</h3>
                <p>CO‚ÇÇ Saved</p>
                {% if potential_co2 > 0 %}
                <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                    Potential: +{{ "%.2f"|format(potential_co2) }} kg
                </small>
                {% endif %}
            </div>
            <div class="impact-card">
                <div class="impact-icon">üå≥</div>
                <h3>{{ "%.1f"|format(trees_saved) }}</h3>
                <p>Trees Saved</p>
                {% if potential_trees > 0 %}
                <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                    Potential: +{{ "%.1f"|format(potential_trees) }}
                </small>
                {% endif %}
            </div>
            <div class="impact-card">
                <div class="impact-icon">‚ôªÔ∏è</div>
                <h3>{{ recycling_rate }}%</h3>
                <p>Recycling Rate</p>
                {% if recycling_rate < 50 and total_entries > 0 %}
                <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                    Keep recycling! üåç
                </small>
                {% endif %}
            </div>
        </div>
        {% if potential_co2 > 0 or potential_trees > 0 %}
        <div class="potential-impact" style="margin-top: 2rem; padding: 1.5rem; background: var(--light-bg); border-radius: 12px; border-left: 4px solid var(--warning-color);">
            <h3 style="margin-bottom: 0.5rem; color: var(--dark-color);">üí° Potential Impact</h3>
            <p style="color: var(--text-color); margin-bottom: 0.5rem;">
                You have recyclable items that haven't been marked as recycled yet.
            </p>
            <p style="color: var(--text-light); font-size: 0.9rem;">
                Mark them as recycled in the "Track Waste" page to see your full environmental impact! Every item counts. üå±
            </p>
        </div>
        {% endif %}
    </div>

    <div class="export-section">
        <a href="{{ url_for('export_data') }}" class="btn btn-primary">üì• Export Data (CSV)</a>
    </div>
</div>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Waste by Type Chart
    const wasteTypeData = {{ waste_by_type|tojson }};
    const typeLabels = Object.keys(wasteTypeData);
    const typeWeights = typeLabels.map(type => wasteTypeData[type].weight || 0);

    const ctx1 = document.getElementById('wasteTypeChart');
    if (ctx1 && typeWeights.some(w => w > 0)) {
        new Chart(ctx1.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: typeLabels.map(t => t.charAt(0).toUpperCase() + t.slice(1)),
                datasets: [{
                    data: typeWeights,
                    backgroundColor: [
                        '#2ecc71',
                        '#3498db',
                        '#e74c3c',
                        '#95a5a6'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
    }

    // Weekly Waste Trend Chart
    const weeklyData = {{ weekly_stats|tojson }};
    const weekKeys = Object.keys(weeklyData).sort();
    
    // Format week labels (e.g., "2024-W01" -> "Week 1, 2024" or just show date range)
    const weekLabels = weekKeys.map(key => {
        // If format is YYYY-WW, extract week number
        if (key.includes('-W')) {
            const [year, week] = key.split('-W');
            return `Week ${week}, ${year}`;
        }
        // If format is YYYY-MM-DD (start of week), format it
        if (key.includes('-')) {
            const parts = key.split('-');
            if (parts.length === 3) {
                const date = new Date(parts[0], parts[1] - 1, parts[2]);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        return key;
    });
    
    const weekCounts = weekKeys.map(week => weeklyData[week].count || 0);
    const weekWeights = weekKeys.map(week => weeklyData[week].weight || 0);

    const ctx2 = document.getElementById('weeklyChart');
    if (ctx2) {
        if (weekKeys.length > 0 && (weekCounts.some(c => c > 0) || weekWeights.some(w => w > 0))) {
            new Chart(ctx2.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [
                        {
                            label: 'Number of Entries',
                            data: weekCounts,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Weight (kg)',
                            data: weekWeights,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: '#2ecc71',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y + ' entries';
                                    } else {
                                        label += context.parsed.y.toFixed(2) + ' kg';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Entries'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Weight (kg)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        } else {
            // Show message if no data
            ctx2.parentElement.innerHTML = '<h2>Weekly Waste Trend</h2><p style="text-align: center; padding: 2rem; color: #666;">No weekly data available yet. Start tracking your waste to see weekly trends!</p>';
        }
    }
});
</script>
{% endblock %}


