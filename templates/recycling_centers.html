{% extends "base.html" %}

{% block title %}Recycling Centers - Ecotrack{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">Recycling Centers</h1>
    
    <div class="centers-container">
        <div class="centers-list-panel">
            <h2>Available Centers</h2>
            {% if centers %}
                <div class="centers-list">
                    {% for center in centers %}
                    <div class="center-card" data-lat="{{ center.latitude }}" data-lng="{{ center.longitude }}">
                        <h3>{{ center.name }}</h3>
                        <p class="center-address">üìç {{ center.address }}, {{ center.city }}</p>
                        {% if center.phone %}
                        <p class="center-contact">üìû {{ center.phone }}</p>
                        {% endif %}
                        {% if center.accepts_types %}
                        <p class="center-types"><strong>Accepts:</strong> {{ center.accepts_types }}</p>
                        {% endif %}
                        {% if center.hours %}
                        <p class="center-hours">üïê {{ center.hours }}</p>
                        {% endif %}
                        <button class="btn btn-sm btn-secondary" onclick="showOnMap({{ center.latitude }}, {{ center.longitude }}, '{{ center.name }}')">Show on Map</button>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-state">No recycling centers found.</p>
            {% endif %}
        </div>

        <div class="map-panel">
            <div id="map" style="width: 100%; height: 600px; border-radius: 8px;"></div>
        </div>
    </div>
</div>

<script>
let map;
let markers = [];
let userMarker = null;

// Initialize map when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const mapElement = document.getElementById('map');
    if (!mapElement) {
        console.error('Map element not found');
        return;
    }

    const defaultLocation = [27.7172, 85.3240]; // Kathmandu coordinates [lat, lng]
    
    try {
        // Initialize Leaflet map
        map = L.map('map').setView(defaultLocation, 12);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Add user location if available
        {% if user_lat and user_lng %}
        const userLocation = [{{ user_lat }}, {{ user_lng }}];
        userMarker = L.marker(userLocation, {
            title: 'Your Location',
            icon: L.divIcon({
                className: 'user-location-marker',
                html: '<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            })
        }).addTo(map);
        userMarker.bindPopup('<strong>Your Location</strong>').openPopup();
        map.setView(userLocation, 12);
        {% endif %}

        // Add markers for recycling centers
        {% for center in centers %}
        const marker{{ center.id }} = L.marker([{{ center.latitude }}, {{ center.longitude }}], {
            title: '{{ center.name|replace("'", "\\'") }}'
        }).addTo(map);

        const popupContent{{ center.id }} = `
            <div style="padding: 10px; max-width: 300px;">
                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">{{ center.name|replace("'", "\\'") }}</h3>
                <p style="margin: 5px 0;"><strong>Address:</strong> {{ center.address|replace("'", "\\'") }}</p>
                {% if center.phone %}<p style="margin: 5px 0;"><strong>Phone:</strong> {{ center.phone }}</p>{% endif %}
                {% if center.accepts_types %}<p style="margin: 5px 0;"><strong>Accepts:</strong> {{ center.accepts_types|replace("'", "\\'") }}</p>{% endif %}
                {% if center.hours %}<p style="margin: 5px 0;"><strong>Hours:</strong> {{ center.hours }}</p>{% endif %}
            </div>
        `;

        marker{{ center.id }}.bindPopup(popupContent{{ center.id }});
        markers.push(marker{{ center.id }});
        {% endfor %}

        // If no centers, show message
        {% if not centers %}
        const noCentersDiv = L.control({position: 'topcenter'});
        noCentersDiv.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'no-centers-message');
            div.innerHTML = '<p style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">No recycling centers available</p>';
            return div;
        };
        noCentersDiv.addTo(map);
        {% endif %}

    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: #e74c3c;"><p>Error loading map. Please refresh the page.</p></div>';
    }
});

function showOnMap(lat, lng, name) {
    if (!map) {
        console.error('Map not initialized');
        return;
    }
    
    const location = [lat, lng];
    map.setView(location, 15);
    
    // Find and open popup for this marker
    markers.forEach((marker) => {
        const markerPos = marker.getLatLng();
        if (Math.abs(markerPos.lat - lat) < 0.0001 && Math.abs(markerPos.lng - lng) < 0.0001) {
            marker.openPopup();
        }
    });
}
</script>
{% endblock %}

